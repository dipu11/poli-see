
TIGER=[];TIGER.ajputil={bindSubmit:function(){$("input[name='phone']").off();$("#AJPRegisterForm").validate();$("#deliveryAddressForm").validate();$("#CSPaymentDetailsForm").validate();},bindAJPFields:function(){$("#register\\.firstName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#register\\.lastName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#register\\.phoneticLastName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#register\\.phoneticFirstName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#profile\\.firstName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#profile\\.lastName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#profile\\.phoneticLastName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#profile\\.phoneticFirstName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.firstName").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.surname").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.middlename").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.middlename2").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.surname_del").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.firstName_del").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.middlename_del").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.middlename2_del").on("keyup change",function(){TIGER.ajputil.restrictMaxBytes(this)});$("#address\\.region").on("change",function(){TIGER.ajputil.selectRegion(this)});$("#address\\.postcode").on("keyup change",function(){TIGER.ajputil.changeRegion(this)});},rakutenButtonBind:function(){$('#rakuten[type="radio"]').on({click:function(e){this.focus();$("button#PlaceOrder").hide();if($("div.placeOrder #rakutenPlaceOrderButton").length==0){$("#rakutenPlaceOrderButton").appendTo($("div.placeOrder"));}
$("div.placeOrder #rakutenPlaceOrderButton").show();}});$("input[name='paymentType'][type='radio']").not($('#rakuten[type="radio"]')).on({click:function(e){if($("div.placeOrder #rakutenPlaceOrderButton").length>0){$("div.placeOrder #rakutenPlaceOrderButton").hide();$("button#PlaceOrder").show();}}});},autoSelectCCDropdown:function(){$(".cardType").attr("disabled",false);var VISA=/^4[0-9]{12}(?:[0-9]{3})?$/;var MASTER=/^(?:5[1-5][0-9]{2}|222[1-9]|22[3-9][0-9]|2[3-6][0-9]{2}|27[01][0-9]|2720)[0-9]{12}$/;var AMEX=/^3[47][0-9]{13}$/;var JCB=/^(?:2131|1800|35\d{3})\d{11}$/;var DINER=/^3(?:0[0-5]|[68][0-9])[0-9]{11}$/;$(".cardNumber").on("keyup change",function(){var currCardNumber=$(this).val();if(currCardNumber&&currCardNumber.length>=13){var cardType="999";if(VISA.test(currCardNumber)){cardType="001";}else if(MASTER.test(currCardNumber)){cardType="002";}else if(AMEX.test(currCardNumber)){cardType="003";}else if(JCB.test(currCardNumber)){cardType="007";}else if(DINER.test(currCardNumber)){cardType="005";}
$(".cardType").val(cardType);}});},countBytes:function(str){var r=0;for(var i=0;i<str.length;i++){var c=str.charCodeAt(i);if((c>=0x0&&c<0x81)||(c==0xf8f0)||(c>=0xff61&&c<0xffa0)||(c>=0xf8f1&&c<0xf8f4)){r+=1;}else{r+=2;}}
return r;},restrictMaxBytes:function(fieldElem){if(!fieldElem)return;var field=$(fieldElem);var maxBytes=field.attr("maxbytes");if(!maxBytes)return;var start=fieldElem.selectionStart;var end=fieldElem.selectionEnd;var currVal=field.val();var currLen=TIGER.ajputil.countBytes(currVal);if(!currLen)return;if(currLen>maxBytes){var ctr=1;do{var startPart=currVal.slice(0,start-ctr);var endPart=currVal.slice(start);formattedVal=startPart+endPart;currLen=TIGER.ajputil.countBytes(formattedVal);ctr++;}while(currLen>maxBytes)
field.val(formattedVal);fieldElem.setSelectionRange(start-1,end-1);}},selectRegion:function(fieldElem){if(!fieldElem)return;var field=$(fieldElem);var selectedText=field.children("option").filter(":selected").text();$("#hdnRegion").val(selectedText);$("[idkey='hdnPrevRegion']").val(selectedText);},changeRegionCodeToName:function(jqFieldElem){if(!jqFieldElem)return;var regionCode=$("[idkey='hdnPrevRegion']").val();if(regionCode){var selectedOption=jqFieldElem.children("option").filter("[value="+regionCode+"]");if(selectedOption){var selectedText=selectedOption.text();$("#hdnRegion").val(selectedText);$("[idkey='hdnPrevRegion']").val(selectedText);}}},changeRegion:function(fieldElem){if(!fieldElem)return;var field=$(fieldElem);var postCode=field.val();var len=-1;if(postCode&&postCode.length){len=postCode.length;}
if(len>=7&&len<=8){var regionText=$("#hdnRegion").val();var prevRegionText=$("[idkey='hdnPrevRegion']").val();if(regionText!=prevRegionText){var regionField=$("#address\\.region");regionField.children("option").filter(function(){return $(this).text()==regionText;}).prop('selected',true);$("[idkey='hdnPrevRegion']").val(regionText);}}},handleCybersourcePlaceOrder:function(savedCard){$(".placeOrder button.place-order").attr('disabled','disabled');if(!savedCard){TIGER.ajputil.initializeCyberSourceCardParameters();}else{var cardHolderName=TIGER.ajputil.getCheckedPaymentMethod().attr("data-name");$("#merchant_defined_data8").val(cardHolderName);}
TIGER.ajputil.initializeCyberSourceParameters();TIGER.ajputil.getCybersourceSignature(savedCard);},handleRakutenPlaceOrder:function(){$(".placeOrder button.place-order").attr('disabled','disabled');$("#rakutenPlaceOrderButton .place-order").attr('disabled','disabled');var termsAndNewsletterUrl=$("#termsAndNewsletterUrl").val();var newsLetterCheck='checked'===$("input[name=newsLetterCheck]").parent().attr("class");$.ajax({url:termsAndNewsletterUrl,data:{newsletterCheck:newsLetterCheck},type:'POST',success:function(data){if(typeof(data)==='string'&&data.indexOf("redirect_detection")!=-1){window.location.href=ACC.config.encodedContextPath+"/login/checkout/error";}else{$('#rakutenForm').submit();}},error:function(xht,textStatus,ex)
{alert("User not logged in. Error details ["+xht+", "+textStatus+", "+ex+"]");}});},handleOtherPlaceOrder:function(){$(".placeOrder button.place-order").attr('disabled','disabled');document.getElementById("selectPaymentMethodForm").submit();},initializeCyberSourceCardParameters:function(){$("#card_number").val($(".cardNumber").val().replace(/\s+/g,''));$("#card_type").val($("select[name='cardTypeCode']").val());$("#card_cvn").val($("#securityCode").val().replace(/\s+/g,''));$("#card_expiry_date").val($("#ExpiryMonth").val()+"-"+$("#ExpiryYear").val());$("#merchant_defined_data8").val($(".nameOnCard").val());},initializeCyberSourceParameters:function(){$("#merchant_defined_data9").val($("input[name='usingDeliveryAddress'][type='checkbox']").prop('checked'));var newsletter=$("#NewsLetter").prop('checked')||false;$("#merchant_defined_data10").val(newsletter);},getCybersourceSignature:function(savedCard){var fn=$("#bill_to_forename").val();var ln=$("#bill_to_surname").val();var m1=$("#merchant_defined_data5").val();var m2=$("#merchant_defined_data6").val();var ph=$("#bill_to_phone").val();var l1=$("#bill_to_address_line1").val();var cy=$("#bill_to_address_city").val();var st=$("#bill_to_address_state").val();var pc=$("#bill_to_address_postal_code").val();var em=$("#bill_to_email").val();var country=$("#bill_to_address_country").val();var bl=$("#merchant_defined_data7").val();var chn=$("#merchant_defined_data8").val();var is=$("input[name='usingDeliveryAddress'][type='checkbox']").prop('checked');var cyberSourceSignatureUrl=$("#cyberSourceSignatureUrl").val();var newsletter=$("#merchant_defined_data10").val();var cyberSourceParams={fn:fn,ln:ln,m1:m1,m2:m2,ph:ph,l1:l1,cy:cy,st:st,pc:pc,em:em,country:country,bl:bl,chn:chn,is:is,newsletter:newsletter};if(savedCard){var subId=TIGER.ajputil.getCheckedPaymentMethod().attr("data-sub");cyberSourceParams['subscriptionId']=subId;}else{if($("#saveCardDetails").length>0){var saveCardDetails=$("#saveCardDetails").is(':checked');cyberSourceParams['saveCardDetails']=saveCardDetails;}}
$.ajax(cyberSourceSignatureUrl,{type:'post',data:$.param(cyberSourceParams),success:function(data){if(data.transactionUuid){$("#transaction_uuid").val(data.transactionUuid);$("#signed_date_time").val(data.signedDataTime);$("#signature").val(data.signature);$("#signed_field_names").val(data.signedFields);$("#transaction_type").val(data.transactionType);if(data.subscriptionId){var subId=data.subscriptionId;$("#payment_token").val(subId);}else{$("#payment_token").remove();}
document.getElementById("addPaymentForm2").submit();}else{if(typeof(data)==='string'&&data.indexOf("redirect_detection")!=-1){window.location.href=ACC.config.encodedContextPath+"/login/checkout/error";}else{location.reload();}}},error:function(data){$(".placeOrder button.place-order").removeAttr('disabled');}});},getCheckedPaymentMethod:function(){var paymentMethods=$("input[name='payment_method']");for(var i=0;i<paymentMethods.length;i++){var paymentMethod=paymentMethods[i];if($(paymentMethod).prop("checked")){return $(paymentMethod);}}}};$(document).ready(function()
{TIGER.ajputil.bindAJPFields();TIGER.ajputil.bindSubmit();TIGER.ajputil.rakutenButtonBind();var field=$("#address\\.region");if(field.length){TIGER.ajputil.changeRegionCodeToName(field);}});
